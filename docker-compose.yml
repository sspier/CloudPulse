# this service runs a local, containerized DynamoDB instance using Amazonâ€™s official DynamoDB Local image.
# it also includes a setup-tables service that initializes the necessary tables for local development and testing.
# to use this setup, run `docker-compose up -d` to start the DynamoDB Local service and create the required tables.
services:
  dynamodb-local:
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath ." # starts DynamoDB Local with shared database and persistent storage
    image: "amazon/dynamodb-local:latest" # runs the in-memory/on-disk local DynamoDB emulator
    container_name: dynamodb-local
    ports:
      - "8000:8000" # maps port 8000 of the container to port 8000 on the host machine
    working_dir: /home/dynamodblocal

  setup-tables:
    image: amazon/aws-cli # uses the AWS CLI image to interact with DynamoDB Local
    depends_on:
      - dynamodb-local
    environment:
      - AWS_ACCESS_KEY_ID=dummy
      - AWS_SECRET_ACCESS_KEY=dummy
      - AWS_REGION=us-east-1
      - AWS_DEFAULT_REGION=us-east-1
    entrypoint: /bin/sh # uses a shell to run multiple commands
    command: >
      -c "
        echo 'Waiting for DynamoDB...';
        sleep 5;
        aws dynamodb create-table --endpoint-url http://dynamodb-local:8000 --table-name cloudpulse-targets-local --attribute-definitions AttributeName=id,AttributeType=S --key-schema AttributeName=id,KeyType=HASH --billing-mode PAY_PER_REQUEST;
        aws dynamodb create-table --endpoint-url http://dynamodb-local:8000 --table-name cloudpulse-probe-results-local --attribute-definitions AttributeName=target_id,AttributeType=S AttributeName=timestamp,AttributeType=N --key-schema AttributeName=target_id,KeyType=HASH AttributeName=timestamp,KeyType=RANGE --billing-mode PAY_PER_REQUEST;
        echo 'Tables created.';
      "
