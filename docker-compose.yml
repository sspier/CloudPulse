version: '3.8'

services:
  dynamodb-local:
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath ."
    image: "amazon/dynamodb-local:latest"
    container_name: dynamodb-local
    ports:
      - "8000:8000"
    working_dir: /home/dynamodblocal

  # We can't easily run the API/Runner containerized without extensive init scripts to create tables.
  # Instead, we will provide the DynamoDB container so the USER can run their go binaries against it.
  # This setup is much simpler and less error-prone for a quick "test run".

  setup-tables:
    image: amazon/aws-cli
    depends_on:
      - dynamodb-local
    environment:
      - AWS_ACCESS_KEY_ID=dummy
      - AWS_SECRET_ACCESS_KEY=dummy
      - AWS_REGION=us-east-1
      - AWS_DEFAULT_REGION=us-east-1
    entrypoint: /bin/sh
    command: >
      -c "
        echo 'Waiting for DynamoDB...';
        sleep 5;
        aws dynamodb create-table --endpoint-url http://dynamodb-local:8000 --table-name cloudpulse-targets-local --attribute-definitions AttributeName=id,AttributeType=S --key-schema AttributeName=id,KeyType=HASH --billing-mode PAY_PER_REQUEST;
        aws dynamodb create-table --endpoint-url http://dynamodb-local:8000 --table-name cloudpulse-probe-results-local --attribute-definitions AttributeName=target_id,AttributeType=S AttributeName=timestamp,AttributeType=N --key-schema AttributeName=target_id,KeyType=HASH AttributeName=timestamp,KeyType=RANGE --billing-mode PAY_PER_REQUEST;
        echo 'Tables created.';
      "
