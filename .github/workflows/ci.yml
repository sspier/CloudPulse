name: CI

on:
  # run CI on every push to main and on all PRs
  push:
    branches: [main]
  pull_request:

permissions:
  # workflow only needs read access for checkout
  contents: read

jobs:
  ############################################
  # go tests + vet
  ############################################
  go-tests:
    name: go tests & vet
    runs-on: ubuntu-latest

    steps:
      # pull repo contents into the runner
      - name: checkout
        uses: actions/checkout@v4

      # install go toolchain
      - name: set up go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      # ensure module dependencies are pulled
      - name: download go modules
        run: go mod download

      # run unit tests across the whole repo
      - name: run go tests
        run: go test ./...

      # static analysis for common mistakes
      - name: run go vet
        run: go vet ./...

  ############################################
  # terraform fmt + validate
  ############################################
  terraform-checks:
    name: terraform fmt & validate
    runs-on: ubuntu-latest

    steps:
      # access the repo code
      - name: checkout
        uses: actions/checkout@v4

      # install terraform cli
      - name: set up terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.11.0

      # enforce terraform formatting across the repo
      - name: terraform fmt (recursive)
        run: terraform fmt -check -recursive

      # validate dev config without touching the real backend
      - name: terraform validate (dev)
        working-directory: infra/envs/dev
        run: |
          terraform init -backend=false
          terraform validate

      # validate prod config as well for parity
      - name: terraform validate (prod)
        working-directory: infra/envs/prod
        run: |
          terraform init -backend=false
          terraform validate

  ############################################
  # docker build verification
  ############################################
  docker-api-build:
    name: build api docker image
    runs-on: ubuntu-latest
    needs: go-tests # only build if tests pass

    steps:
      # checkout source code again for this job
      - name: checkout
        uses: actions/checkout@v4

      # make sure the api dockerfile builds successfully
      - name: build cloudpulse-api image
        run: docker build -t cloudpulse-api:ci -f apps/api/Dockerfile .
