name: cloudpulse

version: "3.9"

services:
  api:
    # builds the cloudpulse api using the Dockerfile in apps/api/Dockerfile
    # context is the project root because the api references code outside this directory
    build:
      context: ../..
      dockerfile: apps/api/Dockerfile

    # expose the port the api listens on
    environment:
      - PORT=8080

    # map container port 8080 to host port 8080 so you can hit the api from the browser or curl
    ports:
      - "8080:8080"

    # ensures the api restarts automatically unless it was manually stopped
    restart: unless-stopped

  prometheus:
    # runs a standard prometheus instance for scraping metrics from the api
    image: prom/prometheus:v2.54.0

    # mount prometheus.yml config from this directory into the container
    # read-only so prometheus canâ€™t modify the local file
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro

    # exposes prometheus dashboard on port 9090
    ports:
      - "9090:9090"

    # auto-restart unless manually stopped
    restart: unless-stopped
